{% extends 'admin/base.html.twig' %}

{% block title %}Créer un challenge{% endblock %}

{% block content %}
    <div class="container">
        <h2 class="my-4">Créer un nouveau challenge</h2>

        <div class="card p-4">
            {{ form_start(form, {
                'attr': {
                    'onsubmit': 'return validateChallengeForm(event)',
                    'novalidate': 'novalidate'  # Désactivation de la validation HTML5 par défaut
                }
            }) }}

            <div class="mb-3">
                {{ form_label(form.name) }}
                {{ form_widget(form.name, {
                    'attr': {
                        'class': 'form-control',
                        'id': form.name.vars.id,
                        'placeholder': 'Entrez le nom du challenge'
                    }
                }) }}
                <div class="text-danger" id="error-{{ form.name.vars.full_name }}"></div>
            </div>

            <div class="mb-3">
                {{ form_label(form.description) }}
                {{ form_widget(form.description, {
                    'attr': {
                        'class': 'form-control',
                        'id': form.description.vars.id,
                        'placeholder': 'Entrez la description du challenge'
                    }
                }) }}
                <div class="text-danger" id="error-{{ form.description.vars.full_name }}"></div>
            </div>

            <div class="mb-3">
                {{ form_label(form.imageFile) }}  <!-- change image to imageFile -->
                {{ form_widget(form.imageFile, {
                    'attr': {
                        'class': 'form-control',
                        'id': form.imageFile.vars.id
                    }
                }) }}
                <div class="text-danger" id="error-{{ form.imageFile.vars.full_name }}"></div>  <!-- change image to imageFile -->
            </div>

            <button type="submit" class="btn btn-success w-100">
                {{ button_label|default('Enregistrer') }}
            </button>

            {{ form_end(form) }}
        </div>

        <div class="mt-3">
            <a href="{{ path('app_challenge_index') }}" class="btn btn-secondary">Retour à la liste</a>
        </div>
    </div>

    {% block challenge_form_validation %}
    <script>
        function validateChallengeForm(event) {
            event.preventDefault(); // Empêche l'envoi par défaut du formulaire

            let isValid = true;

            // Réinitialisation des erreurs
            document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

            // Validation de chaque champ du formulaire
            let nameInput = document.getElementById('{{ form.name.vars.id }}');
            if (!nameInput.value.trim()) {
                isValid = false;
                document.getElementById('error-{{ form.name.vars.full_name }}').textContent =
                    "Le nom du challenge ne peut pas être vide.";
            }

            let descriptionInput = document.getElementById('{{ form.description.vars.id }}');
            if (!descriptionInput.value.trim()) {
                isValid = false;
                document.getElementById('error-{{ form.description.vars.full_name }}').textContent =
                    "La description ne peut pas être vide.";
            }

            let imageInput = document.getElementById('{{ form.imageFile.vars.id }}');
            if (imageInput.files.length > 0) {
                let allowedExtensions = /(\.jpg|\.jpeg|\.png)$/i;
                if (!allowedExtensions.test(imageInput.value)) {
                    isValid = false;
                    document.getElementById('error-{{ form.imageFile.vars.full_name }}').textContent =
                        "Format de fichier invalide. Utilisez JPG ou PNG.";
                }
            }

            // Si tout est valide, soumettre le formulaire
            if (isValid) {
                event.target.submit(); // Soumettre le formulaire
            }

            return false; // Empêche la soumission par défaut
        }
    </script>
    {% endblock %}
{% endblock %}
