{% extends 'admin/base.html.twig' %}

{% block title %}
  {% if produit is defined and produit.id %}
    Modifier un Produit
  {% else %}
    Ajouter un Produit
  {% endif %}
{% endblock %}

{% block content %}
  <h2>
    {% if produit is defined and produit.id %}
      Modifier un Produit
    {% else %}
      Ajouter un Produit
    {% endif %}
  </h2>

  <div class="card p-4">
    {{ form_start(form, {
      attr: {
        onsubmit: 'return validateProduitForm(event)',
        enctype: 'multipart/form-data',
        novalidate: 'novalidate'
      }
    }) }}

      <div class="mb-3">
        {{ form_label(form.nom, 'Nom du Produit') }}
        {{ form_widget(form.nom, { attr: { class: 'form-control', id: 'nom', required: 'required' } }) }}
        {{ form_errors(form.nom) }}
        <div class="text-danger" id="nomError"></div>
      </div>

      <div class="mb-3">
        {{ form_label(form.description, 'Description') }}
        {{ form_widget(form.description, { attr: { class: 'form-control', id: 'description', required: 'required' } }) }}
        {{ form_errors(form.description) }}
        <div class="text-danger" id="descriptionError"></div>
      </div>

      <div class="mb-3">
        {{ form_label(form.prix, 'Prix (TND)') }}
        {{ form_widget(form.prix, { attr: { class: 'form-control', id: 'prix', type: 'number', step: '0.01', required: 'required' } }) }}
        {{ form_errors(form.prix) }}
        <div class="text-danger" id="prixError"></div>
      </div>

      <div class="mb-3">
        {{ form_label(form.stock, 'Stock') }}
        {{ form_widget(form.stock, { attr: { class: 'form-control', id: 'stock', type: 'number', required: 'required' } }) }}
        {{ form_errors(form.stock) }}
        <div class="text-danger" id="stockError"></div>
      </div>

      <div class="mb-3">
        {{ form_label(form.image, 'Image du Produit') }}
        {{ form_widget(form.image, { attr: { class: 'form-control', id: 'image' } }) }}
        {{ form_errors(form.image) }}
        <div class="text-danger" id="imageError"></div>
      </div>

      <div class="mb-3">
        {{ form_label(form.poids, 'Poids (kg)') }}
        {{ form_widget(form.poids, { attr: { class: 'form-control', id: 'poids', type: 'number', step: '0.01', required: 'required' } }) }}
        {{ form_errors(form.poids) }}
        <div class="text-danger" id="poidsError"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100">
        {% if produit is defined and produit.id %}
          Mettre à jour
        {% else %}
          Créer
        {% endif %}
      </button>

    {{ form_end(form) }}
  </div>

  <div class="mt-3 text-center">
    <a href="{{ path('admin_produits') }}" class="btn btn-secondary">Retour à la Liste</a>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");

    const nomEl = document.getElementById("nom");
    const descEl = document.getElementById("description");
    const prixEl = document.getElementById("prix");
    const stockEl = document.getElementById("stock");
    const imageEl = document.getElementById("image");
    const poidsEl = document.getElementById("poids");

    function validateInput(field, errorEl, validator) {
      field.addEventListener("input", function () {
        const errorMessage = validator(field.value.trim());
        errorEl.textContent = errorMessage || "";
      });
    }

    validateInput(nomEl, document.getElementById("nomError"), (value) => 
      value.length < 3 ? "Le nom doit contenir au moins 3 caractères." : ""
    );

    validateInput(descEl, document.getElementById("descriptionError"), (value) => 
      value.length < 10 ? "La description doit contenir au moins 10 caractères." : ""
    );

    validateInput(prixEl, document.getElementById("prixError"), (value) => 
      !value || isNaN(value) || parseFloat(value) <= 0 ? "Le prix doit être un nombre positif." : ""
    );

    validateInput(stockEl, document.getElementById("stockError"), (value) => 
      !value || isNaN(value) || parseInt(value) < 0 ? "Le stock doit être un entier positif ou zéro." : ""
    );

    validateInput(poidsEl, document.getElementById("poidsError"), (value) => 
      !value || isNaN(value) || parseFloat(value) <= 0 ? "Le poids doit être un nombre positif." : ""
    );

    imageEl.addEventListener("change", function () {
      const errorEl = document.getElementById("imageError");
      errorEl.textContent = "";

      {% if produit is not defined or not produit.id %}
        if (imageEl.files.length === 0) {
          errorEl.textContent = "Veuillez sélectionner une image.";
          return;
        }
      {% endif %}

      const allowedTypes = ["image/jpeg", "image/png"];
      if (imageEl.files.length > 0 && !allowedTypes.includes(imageEl.files[0].type)) {
        errorEl.textContent = "Veuillez télécharger une image au format JPEG ou PNG.";
      }
    });

    form.addEventListener("submit", function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
      }
    });
  });
  </script>
{% endblock %}
